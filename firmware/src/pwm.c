

#include "stm32f0xx_rcc.h"
#include "stm32f0xx_gpio.h"
#include "stm32f0xx_tim.h"



#define PWM_PRESCALER   (1U)
#define PWM_PERIOD      (60000U)

uint16_t gamma_table[] = {
    0x0000, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001, 0x0001,
    0x0001, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0002,
    0x0002, 0x0002, 0x0002, 0x0002, 0x0002, 0x0003, 0x0003, 0x0003,
    0x0003, 0x0003, 0x0003, 0x0003, 0x0003, 0x0004, 0x0004, 0x0004,
    0x0004, 0x0004, 0x0005, 0x0005, 0x0005, 0x0005, 0x0005, 0x0006,
    0x0006, 0x0006, 0x0006, 0x0007, 0x0007, 0x0007, 0x0008, 0x0008,
    0x0008, 0x0009, 0x0009, 0x0009, 0x000a, 0x000a, 0x000b, 0x000b,
    0x000c, 0x000c, 0x000d, 0x000d, 0x000e, 0x000e, 0x000f, 0x0010,
    0x0010, 0x0011, 0x0012, 0x0013, 0x0013, 0x0014, 0x0015, 0x0016,
    0x0017, 0x0018, 0x0019, 0x001a, 0x001b, 0x001d, 0x001e, 0x001f,
    0x0020, 0x0022, 0x0023, 0x0025, 0x0027, 0x0028, 0x002a, 0x002c,
    0x002e, 0x0030, 0x0032, 0x0034, 0x0036, 0x0039, 0x003b, 0x003e,
    0x0041, 0x0043, 0x0046, 0x004a, 0x004d, 0x0050, 0x0054, 0x0057,
    0x005b, 0x005f, 0x0063, 0x0068, 0x006c, 0x0071, 0x0076, 0x007b,
    0x0081, 0x0086, 0x008c, 0x0092, 0x0099, 0x009f, 0x00a6, 0x00ae,
    0x00b5, 0x00bd, 0x00c6, 0x00ce, 0x00d7, 0x00e1, 0x00eb, 0x00f5,
    0x0100, 0x010b, 0x0117, 0x0123, 0x0130, 0x013d, 0x014b, 0x0159,
    0x0169, 0x0178, 0x0189, 0x019a, 0x01ac, 0x01bf, 0x01d3, 0x01e7,
    0x01fd, 0x0213, 0x022a, 0x0243, 0x025c, 0x0277, 0x0292, 0x02af,
    0x02cd, 0x02ed, 0x030e, 0x0330, 0x0354, 0x0379, 0x03a0, 0x03c9,
    0x03f4, 0x0420, 0x044e, 0x047f, 0x04b1, 0x04e6, 0x051d, 0x0557,
    0x0593, 0x05d1, 0x0613, 0x0657, 0x069e, 0x06e9, 0x0736, 0x0787,
    0x07dc, 0x0834, 0x0891, 0x08f1, 0x0955, 0x09be, 0x0a2c, 0x0a9e,
    0x0b16, 0x0b92, 0x0c14, 0x0c9c, 0x0d2a, 0x0dbe, 0x0e58, 0x0efa,
    0x0fa2, 0x1052, 0x1109, 0x11c9, 0x1291, 0x1361, 0x143b, 0x151f,
    0x160c, 0x1704, 0x1807, 0x1915, 0x1a2f, 0x1b55, 0x1c88, 0x1dc9,
    0x1f18, 0x2076, 0x21e2, 0x235f, 0x24ed, 0x268c, 0x283d, 0x2a02,
    0x2bda, 0x2dc7, 0x2fca, 0x31e3, 0x3414, 0x365d, 0x38c0, 0x3b3e,
    0x3dd8, 0x4090, 0x4365, 0x465b, 0x4972, 0x4cac, 0x500a, 0x538d,
    0x5739, 0x5b0d, 0x5f0d, 0x6339, 0x6795, 0x6c21, 0x70e1, 0x75d6,
    0x7b03, 0x806a, 0x860d, 0x8bf0, 0x9215, 0x9880, 0x9f32, 0xa630,
    0xad7c, 0xb51a, 0xbd0e, 0xc55b, 0xce06, 0xd712, 0xe084, 0xea60
};



void pwm_init(void)
{
    // vars
    GPIO_InitTypeDef gpio;
    TIM_TimeBaseInitTypeDef tim;
    TIM_OCInitTypeDef oci;

    // enable clock for pwm pins
    RCC_AHBPeriphClockCmd(RCC_AHBPeriph_GPIOC, ENABLE);
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE);

    // configure pins PC6 to PC8 as output
    gpio.GPIO_Mode = GPIO_Mode_AF;
    gpio.GPIO_Speed = GPIO_Speed_50MHz;
    gpio.GPIO_OType = GPIO_OType_PP;
    gpio.GPIO_PuPd = GPIO_PuPd_NOPULL;
    gpio.GPIO_Pin = GPIO_Pin_6 | GPIO_Pin_7 | GPIO_Pin_8;
    GPIO_Init(GPIOC, &gpio);

    GPIO_PinAFConfig(GPIOC, GPIO_PinSource6, GPIO_AF_1);
    GPIO_PinAFConfig(GPIOC, GPIO_PinSource7, GPIO_AF_1);
    GPIO_PinAFConfig(GPIOC, GPIO_PinSource8, GPIO_AF_1);

    GPIO_ResetBits(GPIOC, GPIO_Pin_6 | GPIO_Pin_7 | GPIO_Pin_8);

    // timer 3 timebase configuration
    tim.TIM_Prescaler = PWM_PRESCALER;
    tim.TIM_Period = PWM_PERIOD;
    tim.TIM_CounterMode = TIM_CounterMode_Up;
    tim.TIM_ClockDivision = TIM_CKD_DIV1;
    TIM_TimeBaseInit(TIM3, &tim);

    // timer 3 output compare init
    oci.TIM_OCMode = TIM_OCMode_PWM1;
    oci.TIM_OutputState = TIM_OutputState_Enable;
    oci.TIM_OutputNState = TIM_OutputNState_Disable;
    oci.TIM_OCPolarity = TIM_OCPolarity_High;
    oci.TIM_Pulse = 0;
    TIM_OC1Init(TIM3, &oci);
    TIM_OC2Init(TIM3, &oci);
    TIM_OC3Init(TIM3, &oci);

    // enable everything
    TIM_Cmd(TIM3, ENABLE);
    TIM_CtrlPWMOutputs(TIM3, ENABLE);
}

void pwm_set(uint8_t *rgb)
{
    TIM_SetCompare1(TIM3, gamma_table[rgb[0]]);
    TIM_SetCompare2(TIM3, gamma_table[rgb[1]]);
    TIM_SetCompare3(TIM3, gamma_table[rgb[2]]);
}